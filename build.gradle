plugins {
    id 'java'
    id 'application'
    id 'com.gradleup.shadow' version '9.0.2'
    id 'de.undercouch.download' version '5.6.0'
    id 'org.graalvm.buildtools.native' version '0.10.4'
}

group = 'org.example'
version = '1.0-SNAPSHOT'

repositories { mavenCentral() }

dependencies {
    testImplementation platform('org.junit:junit-bom:5.10.0')
    testImplementation 'org.junit.jupiter:junit-jupiter'
    testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
}

test { useJUnitPlatform() }

/** App settings */
ext {
    appName       = 'Catalan'
    mainClassName = 'org.engine.Main'
}

application {
    mainClass = mainClassName
    applicationDefaultJvmArgs = ['--add-modules', 'jdk.incubator.vector']
}

java { toolchain { languageVersion = JavaLanguageVersion.of(24) } }

// Enable incubator Vector API for compilation and tests
tasks.withType(JavaCompile).configureEach {
    options.compilerArgs += ['--add-modules', 'jdk.incubator.vector']
}

tasks.withType(Test).configureEach {
    jvmArgs '--add-modules', 'jdk.incubator.vector'
}

/** Fat JAR */
tasks.named('shadowJar') {
    archiveBaseName.set(appName)
    archiveClassifier.set('all')
    duplicatesStrategy = DuplicatesStrategy.EXCLUDE
    manifest { attributes 'Main-Class': mainClassName }
}

def buildDirPath  = layout.buildDirectory

// GraalVM reference download URL (not used by the build):
// https://download.oracle.com/graalvm/24/archive/graalvm-jdk-24.0.2_windows-x64_bin.zip

// Ensure GraalVM plugin uses full settings
graalvmNative {
    toolchainDetection = true
    binaries {
        def pgoProfilePath = project.findProperty('pgoProfile') ?: layout.projectDirectory.file('default.iprof').asFile.absolutePath
        all {
            imageName = appName
            jvmArgs.add('--add-modules=jdk.incubator.vector')
            buildArgs.addAll(
                '--no-fallback',
                '-H:+UnlockExperimentalVMOptions',
                '-H:+VectorAPISupport',
                '-J--add-modules=jdk.incubator.vector',
                '--march=x86-64-v3',
                '-O3',
                '--initialize-at-build-time=org.engine',
                '-H:Class=org.engine.Main',
                '-H:NativeLinkerOption=/OPT:REF',
                '-H:NativeLinkerOption=/OPT:ICF'
            )
            resources.autodetect()
        }
        main {
            mainClass.set(mainClassName)
        }
        pgoInstrumented {
            imageName = "${appName}-instr"
            buildArgs.add('-H:PGOInstrument')
        }
        pgoOptimized {
            imageName = "${appName}-pgo"
            buildArgs.add("-H:PGOProfiles=${pgoProfilePath}")
        }
    }
}

// If a local GraalVM exists, point the Native Build Tools launcher to it
def localGraalHome = file('C:\\graalvm\\graalvm-jdk-24.0.2+11.1')
if (localGraalHome.exists()) {
    // Hint Gradle Toolchains to discover this installation (no download)
    System.setProperty('org.gradle.java.installations.paths', localGraalHome.absolutePath)
    graalvmNative {
        binaries {
            all {
                javaLauncher.set(javaToolchains.launcherFor {
                    languageVersion = JavaLanguageVersion.of(24)
                })
            }
        }
    }
}

/** Convenience native meta-task */
tasks.register('packageNative') {
    group = 'distribution'
    description = 'Build the GraalVM native Windows EXE.'
    dependsOn tasks.named('nativeCompile')
}

// Toolchain auto-detection will be used if local GraalVM is not present


tasks.register('nativeInstrument') {
    group = 'distribution'
    description = 'Build PGO-instrumented native exe (run it to produce default.iprof).'
    dependsOn tasks.named('pgoInstrumentedCompile')
}

tasks.register('nativePGO') {
    group = 'distribution'
    description = 'Build PGO-optimized native exe using default.iprof (or -PpgoProfile=...).'
    dependsOn tasks.named('pgoOptimizedCompile')
}
